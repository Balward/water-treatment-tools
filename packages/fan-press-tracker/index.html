<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fan Press Data Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            color: white;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .demo-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .demo-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            background: white;
            border-radius: 15px 15px 0 0;
            display: flex;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-radius: 15px 15px 0 0;
        }

        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .tab-content {
            background: white;
            border-radius: 0 0 15px 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Data Entry Form Styles */
        .form-section {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .form-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .form-grid-compact {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-actions {
            text-align: center;
            margin-top: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        }

        /* Data Table Styles */
        .data-summary {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .data-summary h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
            font-size: 14px;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9ff;
        }

        /* Analysis Tab Styles */
        .analysis-controls {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .control-group select {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }

        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .chart-container h4 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-wrapper {
            height: 300px;
            position: relative;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }

        .chart-wrapper canvas {
            max-width: 100% !important;
            height: auto !important;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-top: 4px solid #667eea;
        }

        .stat-card h4 {
            color: #333;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card .value.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            padding: 5px 10px;
            margin: -5px -10px 5px -10px;
        }

        .stat-card .value.clickable:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .stat-card .unit {
            color: #888;
            font-size: 0.9rem;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-info {
            background: #cce7ff;
            border-color: #007bff;
            color: #004085;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        /* Mobile-First Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }

            .header p {
                font-size: 1rem;
            }

            .demo-button {
                padding: 10px 20px;
                font-size: 14px;
                margin-top: 12px;
            }

            .container {
                padding: 10px;
            }

            .tabs {
                flex-direction: column;
                border-radius: 10px 10px 0 0;
            }
            
            .tab {
                border-radius: 0;
                padding: 15px;
                font-size: 14px;
            }
            
            .tab:first-child {
                border-radius: 10px 10px 0 0;
            }

            .tab.active {
                box-shadow: none;
            }

            .tab-content {
                border-radius: 0 0 10px 10px;
                padding: 20px;
            }

            .form-section {
                margin-bottom: 20px;
                padding: 20px;
            }

            .form-section h3 {
                font-size: 1.1rem;
                margin-bottom: 15px;
            }
            
            .form-grid,
            .form-grid-compact {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .form-group label {
                font-size: 13px;
                margin-bottom: 6px;
            }

            .form-group input,
            .form-group select {
                padding: 10px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .form-actions {
                margin-top: 25px;
            }

            .btn {
                padding: 12px 16px;
                font-size: 14px;
                margin: 5px 2px;
                width: calc(50% - 4px);
                display: inline-block;
                text-align: center;
            }

            .form-actions {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }

            .form-actions .btn {
                flex: 1 1 calc(50% - 4px);
                min-width: 120px;
                max-width: 200px;
            }

            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-card h4 {
                font-size: 0.8rem;
            }

            .stat-card .value {
                font-size: 1.4rem;
            }

            .charts-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .chart-container {
                padding: 15px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow: hidden;
            }

            .chart-container h4 {
                font-size: 1.1rem;
                margin-bottom: 15px;
                word-wrap: break-word;
            }

            .chart-wrapper {
                height: 250px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow: hidden;
                position: relative;
            }

            .analysis-controls {
                padding: 15px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow: hidden;
            }

            .controls-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                width: 100%;
            }

            .control-group {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }

            .control-group label {
                font-size: 13px;
                width: 100%;
                word-wrap: break-word;
            }

            .control-group select {
                padding: 10px;
                font-size: 16px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                border: 2px solid #e1e5e9;
                border-radius: 8px;
            }

            .table-container {
                font-size: 12px;
                max-height: 300px;
            }

            th, td {
                padding: 8px;
                font-size: 12px;
            }

            .data-summary {
                padding: 15px;
            }

            .data-summary h3 {
                font-size: 1.1rem;
            }

            /* Modal responsive */
            .modal-content {
                margin: 10% auto;
                padding: 20px;
                width: 95%;
                max-height: 85vh;
            }

            .modal-header h3 {
                font-size: 1.2rem;
            }

            .settings-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .setting-item {
                padding: 12px;
            }

            .setting-label {
                font-size: 13px;
            }

            .setting-value {
                font-size: 16px;
            }

            .alert {
                padding: 12px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.6rem;
            }

            .stats-cards {
                grid-template-columns: 1fr;
            }

            .btn {
                width: 100%;
                margin: 4px 0;
                padding: 14px 20px;
                font-size: 15px;
            }

            .form-actions .btn {
                flex: 1 1 100%;
                max-width: none;
            }

            .form-section {
                padding: 15px;
            }

            .chart-wrapper {
                height: 200px;
                width: 100%;
                overflow: hidden;
            }

            .chart-container {
                padding: 10px;
                margin: 10px 0;
            }

            .analysis-controls {
                padding: 10px;
            }

            .control-group select {
                padding: 8px;
                font-size: 16px;
            }

            .modal-content {
                padding: 15px;
            }
        }

        /* Touch-friendly improvements */
        @media (pointer: coarse) {
            .btn, .tab, .demo-button {
                min-height: 44px;
            }

            .form-group input,
            .form-group select {
                min-height: 44px;
            }

            .stat-card .value.clickable {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #667eea;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .empty-state p {
            margin-bottom: 25px;
            line-height: 1.6;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }

        .modal-header h3 {
            color: #333;
            margin: 0;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #667eea;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .setting-item {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .setting-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .setting-value {
            font-size: 18px;
            color: #667eea;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🏭 Fan Press Data Tracker</h1>
        <p>Enter new runs and analyze trends to optimize performance</p>
        <button class="demo-button" onclick="loadDemoData()">
            📊 Load Demo Data
        </button>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('entry')">
                📝 Data Entry
            </button>
            <button class="tab" onclick="switchTab('analysis')">
                📈 Analysis & Trends
            </button>
        </div>

        <div class="tab-content">
            <!-- Data Entry Tab -->
            <div id="entry-tab" class="tab-pane active">
                <div class="alert alert-info">
                    <strong>💡 Quick Start:</strong> Enter your Fan Press run data below. All fields are optional, but more data provides better insights. Click "Load Demo Data" above to see sample data.
                </div>

                <div class="alert alert-success">
                    <strong>📱 Cross-Device Sync:</strong> Use "Export Data" to save your data as a JSON file, then "Import Data" on another device to sync your records between phone and laptop.
                </div>

                <form id="fanPressForm">
                    <!-- Run Information & Speed Controls -->
                    <div class="form-section">
                        <h3>📅 Run Info & ⚙️ Speed Controls</h3>
                        <div class="form-grid-compact">
                            <div class="form-group">
                                <label for="date">Date</label>
                                <input type="date" id="date" name="Date">
                            </div>
                            <div class="form-group">
                                <label for="time">Time</label>
                                <input type="time" id="time" name="Time">
                            </div>
                            <div class="form-group">
                                <label for="pressSpeed">Press Speed (%)</label>
                                <input type="number" id="pressSpeed" name="Press Speed %" step="0.01" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label for="mixerSpeed">Mixer Speed (%)</label>
                                <input type="number" id="mixerSpeed" name="Mechanical Mixer Speed %" step="0.01" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label for="augerSpeed">Auger Speed (%)</label>
                                <input type="number" id="augerSpeed" name="2.0 Auger Speed %" step="0.01" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label for="sludgePumpSpeed">Pump Speed (%)</label>
                                <input type="number" id="sludgePumpSpeed" name="Sludge Pump Speed %" step="0.01" min="0" max="100">
                            </div>
                        </div>
                    </div>

                    <!-- Pressure & Flow -->
                    <div class="form-section">
                        <h3>🌊 Pressure & Flow</h3>
                        <div class="form-grid-compact">
                            <div class="form-group">
                                <label for="inletPressureLH">Inlet LH (PSI)</label>
                                <input type="number" id="inletPressureLH" name="Inlet Pressure LH Channel PSI" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label for="gateLH">Gate LH (PSI)</label>
                                <input type="number" id="gateLH" name="Gate LH Channel PSI" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label for="inletPressureRH">Inlet RH (PSI)</label>
                                <input type="number" id="inletPressureRH" name="Inlet Pressure RH Channel PSI" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label for="gateRH">Gate RH (PSI)</label>
                                <input type="number" id="gateRH" name="Gate RH Channel PSI" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label for="mainFlow">Main Flow (GPM)</label>
                                <input type="number" id="mainFlow" name="Main Flow GPM" step="0.01" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Chemical Dosing & Water -->
                    <div class="form-section">
                        <h3>🧪 Chemical Dosing & Water</h3>
                        <div class="form-grid-compact">
                            <div class="form-group">
                                <label for="polyDosing">Poly Rate (GPH)</label>
                                <input type="number" id="polyDosing" name="Poly Dosing Rate GPH" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label for="polymerDilution">Dilution (%)</label>
                                <input type="number" id="polymerDilution" name="Polymer Dilution Rate %" step="0.01" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label for="dilutionWaterTotal">Total Water (GPM)</label>
                                <input type="number" id="dilutionWaterTotal" name="Dilution Water Total Calculated GPM" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label for="preDilutionWater">Pre-Water (GPM)</label>
                                <input type="number" id="preDilutionWater" name="Pre-Dilution Water GPM" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label for="postDilutionWater">Post-Water (GPM)</label>
                                <input type="number" id="postDilutionWater" name="Post-Dilution Water GPM" step="0.01" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Process Conditions & Results -->
                    <div class="form-section">
                        <h3>🌡️ Conditions & 📊 Results</h3>
                        <div class="form-grid-compact">
                            <div class="form-group">
                                <label for="sludgeTemp">Temp (°C)</label>
                                <input type="number" id="sludgeTemp" name="Sludge Temp °C" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="sludgePH">pH (s.u.)</label>
                                <input type="number" id="sludgePH" name="Sludge pH s.u." step="0.01" min="0" max="14">
                            </div>
                            <div class="form-group">
                                <label for="filtrate">Filtrate (NTU)</label>
                                <input type="number" id="filtrate" name="Filtrate NTU" step="0.001" min="0">
                            </div>
                            <div class="form-group">
                                <label for="gtSolids">GT Solids (%)</label>
                                <input type="number" id="gtSolids" name="GT Solids %" step="0.01" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label for="lhCakeSolids">LH Cake (%)</label>
                                <input type="number" id="lhCakeSolids" name="LH Cake Solids %" step="0.01" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label for="rhCakeSolids">RH Cake (%)</label>
                                <input type="number" id="rhCakeSolids" name="RH Cake Solids %" step="0.01" min="0" max="100">
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">💾 Save Run Data</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">🗑️ Clear Form</button>
                        <button type="button" class="btn" onclick="exportData()">📤 Export Data</button>
                        <button type="button" class="btn" onclick="document.getElementById('importFile').click()">📥 Import Data</button>
                        <button type="button" class="btn btn-danger" onclick="clearAllData()">⚠️ Clear All Data</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                    </div>
                </form>

                <!-- Data Summary -->
                <div class="data-summary">
                    <h3 id="dataSummaryTitle">No data entered yet</h3>
                    <p id="dataSummaryText">Add your first Fan Press run using the form above.</p>
                </div>

                <!-- Data Table -->
                <div class="table-container" id="dataTableContainer" style="display: none;">
                    <table id="dataTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Analysis Tab -->
            <div id="analysis-tab" class="tab-pane">
                <div id="analysisContent">
                    <div class="empty-state">
                        <h3>📈 Ready for Analysis</h3>
                        <p>Enter some Fan Press run data in the Data Entry tab to start analyzing trends and performance patterns.</p>
                        <button class="btn" onclick="switchTab('entry')">Go to Data Entry</button>
                    </div>
                </div>

                <div id="analysisDashboard" style="display: none;">
                    <!-- Analysis Controls -->
                    <div class="analysis-controls">
                        <h3>🎯 Analysis Controls</h3>
                        <div class="controls-grid">
                            <div class="control-group">
                                <label for="xAxisSelect">X-Axis Parameter</label>
                                <select id="xAxisSelect"></select>
                            </div>
                            <div class="control-group">
                                <label for="yAxisSelect">Y-Axis Parameter</label>
                                <select id="yAxisSelect"></select>
                            </div>
                            <div class="control-group">
                                <label for="trendParameter">Trend Parameter</label>
                                <select id="trendParameter"></select>
                            </div>
                            <div class="control-group">
                                <label for="optimizationParameter">Optimization Target</label>
                                <select id="optimizationParameter"></select>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="stats-cards" id="statsCards">
                        <!-- Stats will be populated by JavaScript -->
                    </div>

                    <!-- Charts -->
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h4>📊 Parameter Correlation</h4>
                            <div class="chart-wrapper">
                                <canvas id="correlationChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <h4>⏱️ Performance Trend</h4>
                            <div class="chart-wrapper">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <h4>📈 Cake Solids Distribution</h4>
                            <div class="chart-wrapper">
                                <canvas id="distributionChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <h4>🎯 Optimization Insights</h4>
                            <div class="chart-wrapper">
                                <canvas id="optimizationChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for showing maximum cake solids settings -->
    <div id="maxSolidsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🎯 Maximum Cake Solids Settings</h3>
                <span class="close" onclick="closeMaxSolidsModal()">&times;</span>
            </div>
            <div id="maxSolidsSettings">
                <!-- Settings will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let fanPressData = [];
        let charts = {};

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadStoredData();
            updateDataSummary();
            
            // Set current date and time as defaults
            const now = new Date();
            document.getElementById('date').value = now.toISOString().split('T')[0];
            document.getElementById('time').value = now.toTimeString().slice(0, 5);

            // Add form submit handler
            document.getElementById('fanPressForm').addEventListener('submit', handleFormSubmit);
        });

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Initialize analysis tab if switching to it
            if (tabName === 'analysis') {
                initializeAnalysisTab();
            }
        }

        // Embedded demo data - Complete original CSV
        const demoDataCSV = `,Date,Time,"Press Speed 
%","Mechanical Mixer Speed 
%","2.0 Auger Speed 
%","Sludge Pump Speed 
%",Inlet Pressure LH Channel PSI,Gate LH Channel PSI,Main Flow GPM,Inlet Pressure RH Channel PSI,Gate RH Channel PSI,"Poly Dosing Rate 
GPH","Polymer Dilution Rate 
%","Dilution Water Total Calculated 
GPM","Pre-Dilution Water
GPM","Post-Dilution Water
GPM","Sludge Temp
°C","Sludge pH
s.u.","Filtrate
NTU","GT Solids 
%","LH Cake Solids 
%","RH Cake Solids 
%"
,4/18/2024,8:30,40,60,70,20,1.03,10,20,0.72,10,1.6,0.5,5.33,,,12.8,7.02,95.3,3.55,,
,4/18/2024,9:00,45,70,60,20,4.02,25,16,3.56,25,0.9,0.5,3,,,12,7.04,26.2,3.44,13.53,14.57
,4/18/2024,9:30,35,80,60,20,3.32,15,16,3.04,25,0.8,0.5,2.67,3.25,0.75,11.9,6.88,,3.64,14.5,12.74
,4/18/2024,10:00,30,80,40,20,2.97,10,17,2.56,25,0.8,0.5,2.67,3.25,0.75,12,7.05,17.3,3.54,12.46,13.37
,4/18/2024,10:30,25,70,60,20,2.58,20,18,2.16,20,0.75,0.5,2.5,4.25,0.75,12.5,7.02,7.56,3.55,10.1,12.75
,4/18/2024,11:00,25,80,40,20,3.47,20,17,3.08,20,0.85,0.5,2.83,4.25,0.75,12,7.11,15.6,3.5,12.58,14.91
,4/18/2024,11:30,25,60,30,10,0.75,20,25,0.46,20,0.6,0.5,2,3.75,1,11.5,7.13,,2.59,10.69,14.56
,4/18/2024,12:00,,,,,,,,,,,,,,,,,,,,
,4/18/2024,12:30,,,,,,,,,,,,,,,,,,,,
,4/18/2024,13:00,25,60,30,10,3.73,10,19,0.49,20,0.8,0.5,2.67,3.5,0.75,12.1,7.12,,2.8,13.44,14.33
,4/18/2024,13:30,40,70,50,5,2.76,15,20,2.32,20,0.8,0.5,2.67,3.75,0.75,11.8,7.2,67.2,2.75,13.83,11.8
,4/18/2024,14:00,30,70,50,10,1.87,15,10,1.66,15,0.7,0.5,2.33,3.75,0.75,12.2,7.07,36.6,3.26,18.12,16.55
,4/18/2024,14:30,30,70,50,19,2.59,15,11,2.38,15,1,0.5,3.33,3.75,0.75,12.7,7.06,61.7,3.5,11.16,14.13
,4/18/2024,15:00,30,70,60,19,0.89,15,11,0.7,0,0.9,0.5,3,3.75,0.75,12.9,7.05,29.7,3.58,14.22,11.63
,4/18/2024,15:30,30,70,60,19,1.03,15,9,0.65,15,0.9,0.5,3,3.75,0.75,11.7,6.87,46.4,3.57,13.82,17.06
,4/18/2024,16:00,30,70,60,20,0.65,0,8,0.63,0,0.9,0.5,3,3.75,0.75,11.8,6.93,38.9,3.47,18.5,19.45
,,,,,,,,,,,,,,,,,,,,,,
,4/19/2024,9:00,25,70,60,15,2.3,15,8,,,0.8,0.5,2.67,4,1,12.7,7.04,45.8,3.42,17.43,
,4/19/2024,9:30,25,75,60,16,0.96,15,10,,,0.75,0.5,2.5,3.75,1,12.5,7.03,40.5,3.43,16.86,
,4/19/2024,10:00,25,75,60,16,0.83,17,10,,,0.7,0.5,2.33,3.75,1,12.5,7.01,28.4,3.25,15.42,
,4/19/2024,10:30,25,75,60,17,0.95,17,9,,,0.7,0.5,2.33,3,1,12.6,7.04,30.6,3.43,15.73,
,4/19/2024,11:00,25,75,70,18,0.94,18,9,,,0.8,0.5,2.67,3,0,12.4,6.91,40.5,3.49,15.13,
,4/19/2024,11:30,25,75,80,19,1.43,18,10,,,0.75,0.5,2.5,3,0,12.6,7.02,33,3.45,14.01,
,4/19/2024,12:00,25,75,60,19,1.3,18,9,,,0.8,0.5,2.67,3,0,12.6,7.03,34.1,3.33,13.6,
,4/19/2024,12:30,25,70,60,18,0.97,18,10,,,0.85,0.5,2.83,4,1,12,7.05,55.6,3.46,15.09,
,4/19/2024,13:00,25,25,60,18,0.87,18,7,,,0.85,0.5,2.83,1.75,1,12.8,7.04,54.5,3.36,16.48,
,4/19/2024,13:30,25,40,60,22,2.45,18,11,,,0.9,0.5,3,2.5,1.25,12.4,7.04,75.9,3.31,13.73,
,4/19/2024,14:00,25,70,60,19,1.71,18,8,,,0.9,0.5,3,3.5,1,12.8,7.03,80.6,3.43,14.42,
,4/19/2024,14:30,30,70,60,19,1.78,18,8,,,0.9,0.5,3,3.5,1,13.3,7.03,110,3.4,15.09,`;

        // Load demo data
        function loadDemoData() {
            try {
                Papa.parse(demoDataCSV, {
                    header: true,
                    skipEmptyLines: false, // Keep empty lines to preserve row structure
                    complete: function(results) {
                        // Filter and clean the data - keep rows that have at least a date
                        const cleanData = results.data.filter(row => {
                            return row.Date && row.Date.trim() !== '';
                        });

                        // Add demo data to existing data
                        fanPressData = [...fanPressData, ...cleanData];
                        saveDataToStorage();
                        updateDataSummary();
                        updateDataTable();
                        
                        // Show success message
                        showAlert('Demo data loaded successfully! ' + cleanData.length + ' records added.', 'success');
                    },
                    error: function(error) {
                        console.error('Error loading demo data:', error);
                        showAlert('Error loading demo data. Please try again.', 'warning');
                    }
                });
            } catch (error) {
                console.error('Error parsing demo data:', error);
                showAlert('Could not load demo data. Please try again.', 'warning');
            }
        }

        // Handle form submission
        function handleFormSubmit(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const runData = {};

            // Convert form data to object
            for (let [key, value] of formData.entries()) {
                if (value.trim() !== '') {
                    runData[key] = value;
                }
            }

            // Add empty string for unnamed first column to match CSV format
            runData[''] = '';

            // Add timestamp for tracking
            runData._timestamp = new Date().toISOString();

            // Add to data array
            fanPressData.push(runData);
            
            // Save to localStorage
            saveDataToStorage();
            
            
            // Update UI
            updateDataSummary();
            updateDataTable();
            
            // Show success message
            showAlert('Run data saved successfully!', 'success');
            
            // Clear form
            clearForm();
        }

        // Clear form
        function clearForm() {
            document.getElementById('fanPressForm').reset();
            
            // Reset date and time to current
            const now = new Date();
            document.getElementById('date').value = now.toISOString().split('T')[0];
            document.getElementById('time').value = now.toTimeString().slice(0, 5);
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to delete all Fan Press data? This cannot be undone.')) {
                fanPressData = [];
                saveDataToStorage();
                updateDataSummary();
                updateDataTable();
                showAlert('All data cleared.', 'info');
            }
        }

        // Save data to localStorage
        function saveDataToStorage() {
            localStorage.setItem('fanPressData', JSON.stringify(fanPressData));
        }

        // Load data from localStorage
        function loadStoredData() {
            const stored = localStorage.getItem('fanPressData');
            if (stored) {
                fanPressData = JSON.parse(stored);
            }
        }

        // Update data summary
        function updateDataSummary() {
            const titleElement = document.getElementById('dataSummaryTitle');
            const textElement = document.getElementById('dataSummaryText');

            if (fanPressData.length === 0) {
                titleElement.textContent = 'No data entered yet';
                textElement.textContent = 'Add your first Fan Press run using the form above.';
            } else {
                titleElement.textContent = `${fanPressData.length} Fan Press Runs Recorded`;
                
                // Calculate date range
                const dates = fanPressData
                    .map(row => row.Date)
                    .filter(date => date)
                    .sort();
                
                if (dates.length > 0) {
                    const firstDate = dates[0];
                    const lastDate = dates[dates.length - 1];
                    textElement.textContent = firstDate === lastDate ? 
                        `Data from ${firstDate}` : 
                        `Data from ${firstDate} to ${lastDate}`;
                } else {
                    textElement.textContent = 'Ready for analysis in the Analysis tab.';
                }
            }

            // Show/hide data table
            const tableContainer = document.getElementById('dataTableContainer');
            if (fanPressData.length > 0) {
                tableContainer.style.display = 'block';
                updateDataTable();
            } else {
                tableContainer.style.display = 'none';
            }
        }

        // Update data table
        function updateDataTable() {
            if (fanPressData.length === 0) return;

            const table = document.getElementById('dataTable');
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');

            // Get all unique columns
            const allColumns = new Set();
            fanPressData.forEach(row => {
                Object.keys(row).forEach(col => {
                    if (col !== '' && col !== '_timestamp') {
                        allColumns.add(col);
                    }
                });
            });

            const columns = Array.from(allColumns);

            // Create header
            thead.innerHTML = '';
            const headerRow = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // Create body
            tbody.innerHTML = '';
            fanPressData.slice(-10).reverse().forEach((row, index) => {
                const tr = document.createElement('tr');
                columns.forEach(col => {
                    const td = document.createElement('td');
                    td.textContent = row[col] || '';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        // Initialize analysis tab
        function initializeAnalysisTab() {
            if (fanPressData.length === 0) {
                document.getElementById('analysisContent').style.display = 'block';
                document.getElementById('analysisDashboard').style.display = 'none';
                return;
            }

            document.getElementById('analysisContent').style.display = 'none';
            document.getElementById('analysisDashboard').style.display = 'block';

            populateAnalysisControls();
            updateAnalysisCharts();
            updateStatistics();
        }

        // Populate analysis controls
        function populateAnalysisControls() {
            const numericColumns = getNumericColumns();
            const allColumns = getAllColumns();

            // Populate dropdowns
            const selects = ['xAxisSelect', 'yAxisSelect', 'trendParameter', 'optimizationParameter'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '';
                
                const columnsToUse = (selectId === 'trendParameter' || selectId === 'optimizationParameter') ? numericColumns : numericColumns;
                
                columnsToUse.forEach(col => {
                    const option = document.createElement('option');
                    option.value = col;
                    option.textContent = col;
                    select.appendChild(option);
                });
            });

            // Set defaults
            const cakeSolidsCol = numericColumns.find(col => col.includes('Cake Solids'));
            const pressSpeedCol = numericColumns.find(col => col.includes('Press Speed'));

            if (cakeSolidsCol) {
                document.getElementById('yAxisSelect').value = cakeSolidsCol;
                document.getElementById('trendParameter').value = cakeSolidsCol;
                document.getElementById('optimizationParameter').value = cakeSolidsCol;
            }
            if (pressSpeedCol) {
                document.getElementById('xAxisSelect').value = pressSpeedCol;
            }

            // Add event listeners
            selects.forEach(selectId => {
                document.getElementById(selectId).addEventListener('change', updateAnalysisCharts);
            });
        }

        // Get numeric columns
        function getNumericColumns() {
            const columns = getAllColumns();
            return columns.filter(col => {
                const sample = fanPressData.slice(0, 5)
                    .map(row => parseFloat(row[col]))
                    .filter(val => !isNaN(val));
                return sample.length > 0;
            });
        }

        // Get all columns
        function getAllColumns() {
            const allColumns = new Set();
            fanPressData.forEach(row => {
                Object.keys(row).forEach(col => {
                    if (col !== '' && col !== '_timestamp') {
                        allColumns.add(col);
                    }
                });
            });
            return Array.from(allColumns);
        }

        // Update analysis charts
        function updateAnalysisCharts() {
            updateCorrelationChart();
            updateTrendChart();
            updateDistributionChart();
            updateOptimizationChart();
        }

        // Update correlation chart
        function updateCorrelationChart() {
            const ctx = document.getElementById('correlationChart').getContext('2d');
            const xCol = document.getElementById('xAxisSelect').value;
            const yCol = document.getElementById('yAxisSelect').value;

            const filteredData = getFilteredData();
            const data = filteredData.map(row => ({
                x: parseFloat(row[xCol]) || 0,
                y: parseFloat(row[yCol]) || 0
            })).filter(point => point.x !== 0 && point.y !== 0);

            if (charts.correlation) charts.correlation.destroy();

            charts.correlation = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: `${yCol} vs ${xCol}`,
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: 10
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xCol
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yCol
                            }
                        }
                    }
                }
            });
        }

        // Update trend chart
        function updateTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            const trendCol = document.getElementById('trendParameter').value;

            const filteredData = getFilteredData();
            const data = filteredData
                .map((row, index) => ({
                    x: row.Date && row.Time ? new Date(`${row.Date} ${row.Time}`) : index,
                    y: parseFloat(row[trendCol]) || 0
                }))
                .filter(point => point.y !== 0)
                .sort((a, b) => {
                    if (a.x instanceof Date && b.x instanceof Date) {
                        return a.x - b.x;
                    }
                    return a.x - b.x;
                });

            if (charts.trend) charts.trend.destroy();

            const isTimeData = data.length > 0 && data[0].x instanceof Date;

            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: trendCol,
                        data: data,
                        borderColor: 'rgba(40, 167, 69, 1)',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.1,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: 10
                    },
                    scales: {
                        x: {
                            type: isTimeData ? 'time' : 'linear',
                            title: {
                                display: true,
                                text: isTimeData ? 'Date/Time' : 'Run Number'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: trendCol
                            }
                        }
                    }
                }
            });
        }

        // Update distribution chart
        function updateDistributionChart() {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            const cakeSolidsCol = getAllColumns().find(col => col.includes('Cake Solids')) || 'LH Cake Solids %';

            const filteredData = getFilteredData();
            const values = filteredData
                .map(row => parseFloat(row[cakeSolidsCol]))
                .filter(val => !isNaN(val) && val > 0)
                .sort((a, b) => a - b);

            if (values.length === 0) return;

            // Create histogram bins
            const binCount = Math.min(10, Math.ceil(Math.sqrt(values.length)));
            const min = Math.min(...values);
            const max = Math.max(...values);
            const binSize = (max - min) / binCount;

            const bins = Array(binCount).fill(0);
            const binLabels = [];

            for (let i = 0; i < binCount; i++) {
                const binStart = min + i * binSize;
                const binEnd = binStart + binSize;
                binLabels.push(`${binStart.toFixed(1)}-${binEnd.toFixed(1)}`);

                values.forEach(val => {
                    if (val >= binStart && (val < binEnd || i === binCount - 1)) {
                        bins[i]++;
                    }
                });
            }

            if (charts.distribution) charts.distribution.destroy();

            charts.distribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: binLabels,
                    datasets: [{
                        label: 'Frequency',
                        data: bins,
                        backgroundColor: 'rgba(118, 75, 162, 0.6)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: 10
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: `${cakeSolidsCol} Range`
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Runs'
                            }
                        }
                    }
                }
            });
        }

        // Update optimization chart
        function updateOptimizationChart() {
            const ctx = document.getElementById('optimizationChart').getContext('2d');
            const numericColumns = getNumericColumns();
            const optimizationTarget = document.getElementById('optimizationParameter').value || 
                                     numericColumns.find(col => col.includes('Cake Solids')) || 
                                     numericColumns[0];

            if (!optimizationTarget) return;

            // Calculate correlations
            const correlations = numericColumns
                .filter(col => col !== optimizationTarget)
                .map(col => ({
                    parameter: col,
                    correlation: calculateCorrelation(col, optimizationTarget)
                }))
                .sort((a, b) => Math.abs(b.correlation) - Math.abs(a.correlation))
                .slice(0, 8);

            if (charts.optimization) charts.optimization.destroy();

            charts.optimization = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: correlations.map(item => item.parameter.replace(/ /g, '\n')),
                    datasets: [{
                        label: `Correlation with ${optimizationTarget}`,
                        data: correlations.map(item => item.correlation),
                        backgroundColor: correlations.map(item => 
                            item.correlation > 0 ? 'rgba(40, 167, 69, 0.6)' : 'rgba(220, 53, 69, 0.6)'
                        ),
                        borderColor: correlations.map(item => 
                            item.correlation > 0 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)'
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: 10
                    },
                    scales: {
                        y: {
                            min: -1,
                            max: 1,
                            title: {
                                display: true,
                                text: 'Correlation Coefficient'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Variables Most Correlated with ${optimizationTarget}`,
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
        }

        // Calculate correlation
        function calculateCorrelation(xCol, yCol) {
            const pairs = getFilteredData()
                .map(row => [parseFloat(row[xCol]), parseFloat(row[yCol])])
                .filter(pair => !isNaN(pair[0]) && !isNaN(pair[1]));

            if (pairs.length < 2) return 0;

            const n = pairs.length;
            const sumX = pairs.reduce((sum, pair) => sum + pair[0], 0);
            const sumY = pairs.reduce((sum, pair) => sum + pair[1], 0);
            const sumXY = pairs.reduce((sum, pair) => sum + pair[0] * pair[1], 0);
            const sumX2 = pairs.reduce((sum, pair) => sum + pair[0] * pair[0], 0);
            const sumY2 = pairs.reduce((sum, pair) => sum + pair[1] * pair[1], 0);

            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

            return denominator === 0 ? 0 : numerator / denominator;
        }

        // Get filtered data (all data - no date filtering)
        function getFilteredData() {
            return fanPressData;
        }

        // Update statistics
        function updateStatistics() {
            const filteredData = getFilteredData();
            const statsContainer = document.getElementById('statsCards');
            
            if (filteredData.length === 0) {
                statsContainer.innerHTML = '<div class="stat-card"><h4>No Data</h4><div class="value">0</div></div>';
                return;
            }

            // Calculate key statistics
            const numericColumns = getNumericColumns();
            const cakeSolidsCol = numericColumns.find(col => col.includes('Cake Solids'));
            
            let stats = [
                {
                    title: 'Total Runs',
                    value: filteredData.length,
                    unit: 'runs'
                }
            ];

            if (cakeSolidsCol) {
                const cakeSolidsValues = filteredData
                    .map(row => parseFloat(row[cakeSolidsCol]))
                    .filter(val => !isNaN(val));

                if (cakeSolidsValues.length > 0) {
                    const avg = cakeSolidsValues.reduce((a, b) => a + b, 0) / cakeSolidsValues.length;
                    const max = Math.max(...cakeSolidsValues);
                    const min = Math.min(...cakeSolidsValues);

                    stats.push(
                        {
                            title: 'Avg Cake Solids',
                            value: avg.toFixed(1),
                            unit: '%'
                        },
                        {
                            title: 'Max Cake Solids',
                            value: max.toFixed(1),
                            unit: '%'
                        },
                        {
                            title: 'Min Cake Solids',
                            value: min.toFixed(1),
                            unit: '%'
                        }
                    );
                }
            }

            // Add date range info
            const dates = filteredData
                .map(row => row.Date)
                .filter(date => date)
                .sort();

            if (dates.length > 0) {
                const daySpan = dates.length > 1 ? 
                    Math.ceil((new Date(dates[dates.length - 1]) - new Date(dates[0])) / (1000 * 60 * 60 * 24)) + 1 : 1;
                
                stats.push({
                    title: 'Date Range',
                    value: daySpan,
                    unit: daySpan === 1 ? 'day' : 'days'
                });
            }

            // Render stats
            statsContainer.innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <h4>${stat.title}</h4>
                    <div class="value ${stat.title === 'Max Cake Solids' ? 'clickable' : ''}" 
                         ${stat.title === 'Max Cake Solids' ? 'onclick="showMaxSolidsSettings()" title="Click to see settings"' : ''}>${stat.value}</div>
                    <div class="unit">${stat.unit}</div>
                </div>
            `).join('');
        }

        // Show maximum cake solids settings
        function showMaxSolidsSettings() {
            const filteredData = getFilteredData();
            const numericColumns = getNumericColumns();
            const cakeSolidsCol = numericColumns.find(col => col.includes('Cake Solids'));
            
            if (!cakeSolidsCol || filteredData.length === 0) {
                showAlert('No cake solids data available.', 'warning');
                return;
            }

            // Find the record with maximum cake solids
            const maxSolidsRecord = filteredData.reduce((max, row) => {
                const currentSolids = parseFloat(row[cakeSolidsCol]) || 0;
                const maxSolids = parseFloat(max[cakeSolidsCol]) || 0;
                return currentSolids > maxSolids ? row : max;
            });

            const maxSolidsValue = parseFloat(maxSolidsRecord[cakeSolidsCol]);

            // Get all available columns and their values for this record
            const settingsContainer = document.getElementById('maxSolidsSettings');
            const allColumns = getAllColumns();
            
            // Group related parameters
            const parameterGroups = {
                'Run Info': ['Date', 'Time'],
                'Speed Controls': ['Press Speed %', 'Mechanical Mixer Speed %', '2.0 Auger Speed %', 'Sludge Pump Speed %'],
                'Pressures': ['Inlet Pressure LH Channel PSI', 'Gate LH Channel PSI', 'Inlet Pressure RH Channel PSI', 'Gate RH Channel PSI'],
                'Flow & Chemical': ['Main Flow GPM', 'Poly Dosing Rate GPH', 'Polymer Dilution Rate %'],
                'Water': ['Dilution Water Total Calculated GPM', 'Pre-Dilution Water GPM', 'Post-Dilution Water GPM'],
                'Conditions': ['Sludge Temp °C', 'Sludge pH s.u.', 'Filtrate NTU'],
                'Results': ['GT Solids %', 'LH Cake Solids %', 'RH Cake Solids %']
            };

            let html = `<div class="alert alert-success" style="margin-bottom: 20px;">
                <strong>🎯 Maximum Performance:</strong> ${maxSolidsValue.toFixed(2)}% cake solids achieved with these settings:
            </div>`;

            Object.entries(parameterGroups).forEach(([groupName, columns]) => {
                const groupColumns = columns.filter(col => allColumns.includes(col) && maxSolidsRecord[col] && maxSolidsRecord[col].toString().trim() !== '');
                
                if (groupColumns.length > 0) {
                    html += `<h4 style="color: #333; margin: 20px 0 15px 0; font-size: 1.1rem;">${groupName}</h4>`;
                    html += `<div class="settings-grid">`;
                    
                    groupColumns.forEach(col => {
                        const value = maxSolidsRecord[col];
                        if (value && value.toString().trim() !== '') {
                            // Shorten column names for display
                            let displayName = col
                                .replace('Mechanical Mixer Speed %', 'Mixer Speed')
                                .replace('2.0 Auger Speed %', 'Auger Speed')
                                .replace('Sludge Pump Speed %', 'Pump Speed')
                                .replace('Inlet Pressure LH Channel PSI', 'Inlet LH')
                                .replace('Gate LH Channel PSI', 'Gate LH')
                                .replace('Inlet Pressure RH Channel PSI', 'Inlet RH')
                                .replace('Gate RH Channel PSI', 'Gate RH')
                                .replace('Poly Dosing Rate GPH', 'Poly Rate')
                                .replace('Polymer Dilution Rate %', 'Dilution Rate')
                                .replace('Dilution Water Total Calculated GPM', 'Total Water')
                                .replace('Pre-Dilution Water GPM', 'Pre-Water')
                                .replace('Post-Dilution Water GPM', 'Post-Water')
                                .replace('Sludge Temp °C', 'Temperature')
                                .replace('Sludge pH s.u.', 'pH')
                                .replace('Filtrate NTU', 'Filtrate')
                                .replace('LH Cake Solids %', 'LH Cake')
                                .replace('RH Cake Solids %', 'RH Cake');

                            html += `
                                <div class="setting-item">
                                    <div class="setting-label">${displayName}</div>
                                    <div class="setting-value">${value}</div>
                                </div>
                            `;
                        }
                    });
                    
                    html += `</div>`;
                }
            });

            settingsContainer.innerHTML = html;
            document.getElementById('maxSolidsModal').style.display = 'block';
        }

        // Close maximum cake solids modal
        function closeMaxSolidsModal() {
            document.getElementById('maxSolidsModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('maxSolidsModal');
            if (event.target === modal) {
                closeMaxSolidsModal();
            }
        }

        // Export data
        function exportData() {
            if (fanPressData.length === 0) {
                showAlert('No data to export. Add some Fan Press runs first.', 'warning');
                return;
            }

            try {
                const exportObj = {
                    exportDate: new Date().toISOString(),
                    version: '1.0',
                    appName: 'Fan Press Data Tracker',
                    dataCount: fanPressData.length,
                    data: fanPressData
                };

                const dataStr = JSON.stringify(exportObj, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `fan-press-data-${new Date().toISOString().split('T')[0]}.json`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showAlert(`Successfully exported ${fanPressData.length} records to JSON file.`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                showAlert('Error exporting data. Please try again.', 'warning');
            }
        }

        // Import data
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate the imported data
                    if (!importedData.data || !Array.isArray(importedData.data)) {
                        throw new Error('Invalid file format');
                    }

                    const importCount = importedData.data.length;
                    const currentCount = fanPressData.length;

                    // Ask user how to handle the import
                    const action = confirm(`This will import ${importCount} records.\n\nClick OK to ADD to existing data (${currentCount} records).\nClick Cancel to REPLACE all existing data.`);

                    if (action) {
                        // Add to existing data
                        fanPressData = [...fanPressData, ...importedData.data];
                        showAlert(`Successfully imported ${importCount} records. Total: ${fanPressData.length}`, 'success');
                    } else {
                        // Replace existing data
                        fanPressData = [...importedData.data];
                        showAlert(`Successfully replaced all data with ${importCount} imported records.`, 'success');
                    }

                    // Save and refresh UI
                    saveDataToStorage();
                    updateDataSummary();
                    updateDataTable();

                } catch (error) {
                    console.error('Import error:', error);
                    showAlert('Error importing data. Please check the file format and try again.', 'warning');
                }
            };
            
            reader.readAsText(file);
            // Clear the input so the same file can be imported again
            event.target.value = '';
        }

        // Show alert
        function showAlert(message, type = 'info') {
            // Remove existing alerts
            document.querySelectorAll('.alert').forEach(alert => {
                if (alert.classList.contains('alert-temp')) {
                    alert.remove();
                }
            });

            // Create new alert
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-temp`;
            alert.textContent = message;

            // Insert at top of active tab
            const activeTab = document.querySelector('.tab-pane.active');
            activeTab.insertBefore(alert, activeTab.firstChild);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

    </script>
</body>
</html>