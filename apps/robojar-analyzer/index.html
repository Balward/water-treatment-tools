<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RoboJar Data Analyzer - Enhanced with Statistics</title>
    <link rel="icon" type="image/png" href="../../city-logos/favicon.png" />

    <!-- External Library Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Local Stylesheets -->
    <link rel="stylesheet" href="styles.css?v=1" />
  </head>

  <body>
    <div class="header">
      <div class="header-content">
        <div class="header-main">
          <h1>🤖 RoboJar Data Analyzer</h1>
          <p>
            Upload your RoboJar Excel report to visualize and analyze the data
          </p>
        </div>
        <div class="header-actions">
          <button
            class="action-btn"
            id="generateChartsHeader"
            onclick="generateAllCharts()"
            disabled
          >
            <span>📊</span>
            <span>Generate Charts</span>
          </button>
          <button
            class="action-btn"
            id="exportPdfHeader"
            onclick="generatePdfReport()"
            disabled
          >
            <span>📄</span>
            <span>Export PDF</span>
          </button>
          <button
            class="action-btn btn-help"
            onclick="openStatsHelp()"
            title="View Help Documentation"
          >
            <span>ℹ️</span>
            <span>Help</span>
          </button>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="instructions-section">
        <div class="instructions-card">
          <h3>📝 Quick Instructions</h3>
          <ol class="instructions-list">
            <li>
              <strong>Upload:</strong> Choose a RoboJar Excel report file
              (.xlsx/.xls) or load test file for demo
            </li>
            <li>
              <strong>Generate:</strong> Click "Generate Charts" to create
              visualizations for all parameters automatically
            </li>
            <li>
              <strong>Navigate:</strong> Use the tabs (Mean Diameter, Mean
              Volume, Particle Count, Concentration) to view different analyses
            </li>
            <li>
              <strong>Configure:</strong> Adjust forecasting methods, time
              windows, and data filtering options as needed
            </li>
            <li>
              <strong>Export:</strong> Generate comprehensive PDF reports with
              all data
            </li>
          </ol>
          <p class="instructions-tip">
            💡 <strong>Tip:</strong> Use the "ℹ️" Help button in the header for
            detailed explanations of statistics and forecast metrics.
          </p>

          <div class="instructions-actions">
            <div class="file-input-wrapper">
              <input
                type="file"
                id="fileInput"
                class="file-input"
                accept=".xls,.xlsx"
              />
              <button type="button" class="btn btn-large" onclick="document.getElementById('fileInput').click()">
                📁 Import RoboJar Excel File
              </button>
            </div>
            <button
              id="loadTestFile"
              class="btn btn-large"
              onclick="loadTestFile()"
            >
              🧪 Load Test File
            </button>
            <button
              id="loadStreamingCurrentDemo"
              class="btn btn-large"
              onclick="loadStreamingCurrentDemo()"
            >
              ⚡ Load Streaming Current Demo Data
            </button>
          </div>
          <p class="test-file-hint">
            Load Test File uses RoboJarReport from data folder for quick testing<br>
            Streaming Current Demo uses streaming current data with zeta potential measurements
          </p>
        </div>
      </div>

      <!-- Data Summary Section - Moved up for better UX flow -->
      <div class="info-panel" id="infoPanel" style="display: none">
        <div class="sheet-info-card" id="sheetInfo"></div>
      </div>

      <!-- Basic Chart Configuration -->
      <div class="basic-config" id="basicConfig" style="display: none">
        <div class="control-card">
          <h3>📊 Chart Configuration</h3>
          <div class="control-card-controls">
            <div class="control-group">
              <label for="chartType">Chart Type:</label>
              <select id="chartType">
                <option value="line">Line Chart</option>
                <option value="scatter">Scatter Plot</option>
              </select>
            </div>

            <div class="control-group">
              <label for="includeRPM"
                >Include Paddle RPM (Secondary Axis):</label
              >
              <select id="includeRPM">
                <option value="false">No</option>
                <option value="true" selected>Yes</option>
              </select>
            </div>
          </div>

          <div class="forecast-section">
            <h3>🔮 Forecasting Options</h3>

            <div class="forecast-controls">
              <div class="control-group">
                <label for="enableForecast">Forecasting Method:</label>
                <select id="enableForecast">
                  <option value="false" selected>Disabled</option>
                  <option value="adaptive">Adaptive (Recommended)</option>
                  <option value="windowed">Windowed</option>
                  <option value="weighted">Weighted</option>
                  <option value="simple">Simple</option>
                </select>
              </div>

              <div
                class="control-group"
                id="polynomialOrderGroup"
                style="display: none"
              >
                <label for="polynomialOrder">Polynomial Order:</label>
                <select id="polynomialOrder">
                  <option value="1">1st Order (Linear)</option>
                  <option value="2" selected>2nd Order (Quadratic)</option>
                  <option value="3">3rd Order (Cubic)</option>
                </select>
              </div>

              <div
                class="control-group"
                id="forecastStartGroup"
                style="display: none"
              >
                <label for="forecastStart">Forecast Start Time:</label>
                <select id="forecastStart">
                  <option value="600">600s (10 min)</option>
                  <option value="900">900s (15 min)</option>
                  <option value="1200" selected>1200s (20 min)</option>
                  <option value="1500">1500s (25 min)</option>
                  <option value="1800">1800s (30 min)</option>
                </select>
              </div>

              <div
                class="control-group"
                id="forecastWindowGroup"
                style="display: none"
              >
                <label for="forecastWindow">Forecast Window:</label>
                <select id="forecastWindow">
                  <option value="50">50 points (250 seconds)</option>
                  <option value="100" selected>100 points (500 seconds)</option>
                  <option value="150">150 points (750 seconds)</option>
                  <option value="200">200 points (1000 seconds)</option>
                  <option value="all">All data</option>
                </select>
              </div>
            </div>
          </div>

          <div
            id="forecastInfo"
            class="forecast-info"
            style="display: none"
          ></div>
        </div>
      </div>

      <!-- Tabbed Charts Container -->
      <div
        class="tabbed-charts-container"
        id="tabbedChartsContainer"
        style="display: none"
      >
        <div class="tabs-header">
          <button
            class="tab-button active"
            onclick="switchTab('mean-diameter')"
            data-tab="mean-diameter"
          >
            📏 Mean Diameter
          </button>
          <button
            class="tab-button"
            onclick="switchTab('mean-volume')"
            data-tab="mean-volume"
          >
            📦 Mean Volume
          </button>
          <button
            class="tab-button"
            onclick="switchTab('particle-count')"
            data-tab="particle-count"
          >
            🧮 Particle Count
          </button>
          <button
            class="tab-button"
            onclick="switchTab('concentration')"
            data-tab="concentration"
          >
            🧪 Concentration
          </button>
        </div>

        <!-- Mean Diameter Tab -->
        <div class="tab-content active" id="mean-diameter-tab">
          <div class="chart-container">
            <div id="meanDiameterTitle" class="chart-title"></div>
            <div id="meanDiameterLegend" class="custom-legend"></div>
            <div class="chart-canvas-container">
              <canvas id="meanDiameterChart"></canvas>
            </div>
          </div>

          <div class="statistics-section">
            <div class="statistics-card">
              <h3>📊 Mean Diameter Statistics</h3>
              <div class="stats-controls">
                <div class="control-group">
                  <label for="timeWindow">Analysis Time Window:</label>
                  <select id="timeWindow">
                    <option value="all">Full Duration</option>
                    <option value="steady">
                      Steady State Only (After 5 min)
                    </option>
                    <option value="final">Final 10 Minutes</option>
                    <option value="custom">Custom Range</option>
                  </select>
                </div>
                <div
                  class="control-group"
                  id="customRangeGroup"
                  style="
                    display: none;
                    flex-direction: row;
                    gap: 20px;
                    align-items: center;
                  "
                >
                  <div style="display: flex; flex-direction: column; gap: 5px">
                    <label for="startTime">Start Time (seconds):</label>
                    <select id="startTime" style="width: 120px">
                      <option value="0">0 (Start)</option>
                      <option value="300">300 (5 min)</option>
                      <option value="600">600 (10 min)</option>
                      <option value="900">900 (15 min)</option>
                      <option value="1200">1200 (20 min)</option>
                    </select>
                  </div>
                  <div style="display: flex; flex-direction: column; gap: 5px">
                    <label for="endTime">End Time (seconds):</label>
                    <select id="endTime" style="width: 120px">
                      <option value="600">600 (10 min)</option>
                      <option value="900">900 (15 min)</option>
                      <option value="1200">1200 (20 min)</option>
                      <option value="1500">1500 (25 min)</option>
                      <option value="1800" selected>1800 (30 min)</option>
                    </select>
                  </div>
                </div>
              </div>
              <div id="meanDiameterStats"></div>
            </div>

            <div class="metrics-card">
              <h3>📈 Forecast Quality Metrics</h3>
              <div class="metrics-grid" id="meanDiameterMetrics"></div>
              <div
                class="metrics-summary"
                id="meanDiameterMetricsSummary"
              ></div>
            </div>
          </div>
        </div>

        <!-- Mean Volume Tab -->
        <div class="tab-content" id="mean-volume-tab">
          <div class="chart-container">
            <div id="meanVolumeTitle" class="chart-title"></div>
            <div id="meanVolumeLegend" class="custom-legend"></div>
            <div class="chart-canvas-container">
              <canvas id="meanVolumeChart"></canvas>
            </div>
          </div>

          <div class="statistics-section">
            <div class="statistics-card">
              <h3>📊 Mean Volume Statistics</h3>
              <div id="meanVolumeStats"></div>
            </div>
            <div class="metrics-card">
              <h3>📈 Forecast Quality Metrics</h3>
              <div class="metrics-grid" id="meanVolumeMetrics"></div>
              <div class="metrics-summary" id="meanVolumeMetricsSummary"></div>
            </div>
          </div>
        </div>

        <!-- Particle Count Tab -->
        <div class="tab-content" id="particle-count-tab">
          <div class="chart-container">
            <div id="particleCountTitle" class="chart-title"></div>
            <div id="particleCountLegend" class="custom-legend"></div>
            <div class="chart-canvas-container">
              <canvas id="particleCountChart"></canvas>
            </div>
          </div>

          <div class="statistics-section">
            <div class="statistics-card">
              <h3>📊 Particle Count Statistics</h3>
              <div id="particleCountStats"></div>
            </div>
            <div class="metrics-card">
              <h3>📈 Forecast Quality Metrics</h3>
              <div class="metrics-grid" id="particleCountMetrics"></div>
              <div
                class="metrics-summary"
                id="particleCountMetricsSummary"
              ></div>
            </div>
          </div>
        </div>

        <!-- Concentration Tab -->
        <div class="tab-content" id="concentration-tab">
          <div class="chart-container">
            <div id="concentrationTitle" class="chart-title"></div>
            <div id="concentrationLegend" class="custom-legend"></div>
            <div class="chart-canvas-container">
              <canvas id="concentrationChart"></canvas>
            </div>
          </div>

          <div class="statistics-section">
            <div class="statistics-card">
              <h3>📊 Concentration Statistics</h3>
              <div id="concentrationStats"></div>
            </div>
            <div class="metrics-card">
              <h3>📈 Forecast Quality Metrics</h3>
              <div class="metrics-grid" id="concentrationMetrics"></div>
              <div
                class="metrics-summary"
                id="concentrationMetricsSummary"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistics Help Modal -->
    <div id="statsHelpModal" class="help-modal" style="display: none">
      <div class="help-modal-content">
        <button class="modal-close-x" onclick="closeStatsHelp()" title="Close">
          &times;
        </button>
        <h3>📖 RoboJar Analyzer - Complete User Guide</h3>

        <div class="help-metric">
          <h4>🚀 Getting Started</h4>
          <p>
            <strong>File Upload:</strong> Choose a RoboJar Excel report file
            (.xlsx/.xls) using the Import button, or click "Load Test File" to
            try the analyzer with sample data.
          </p>
          <p>
            <strong>Generate Charts:</strong> Click "Generate Charts" in the
            header to automatically create visualizations for all four
            parameters (Mean Diameter, Mean Volume, Particle Count,
            Concentration).
          </p>
          <p>
            <strong>Navigate Tabs:</strong> Use the tabs to switch between
            different parameter analyses. Each tab shows charts, statistics, and
            forecast metrics for that specific measurement.
          </p>
        </div>

        <div class="help-metric">
          <h4>🤖 Understanding RoboJar Data</h4>
          <p>
            <strong>Mean Diameter:</strong> Average particle size, typically
            measured in micrometers (μm). Key indicator of flocculation
            effectiveness.
          </p>
          <p>
            <strong>Mean Volume:</strong> Average volume of particles. Often
            correlates with settling characteristics and treatment efficiency.
          </p>
          <p>
            <strong>Particle Count:</strong> Number of particles detected per
            unit volume. Higher counts may indicate poor coagulation.
          </p>
          <p>
            <strong>Concentration:</strong> Total particle concentration, often
            expressed as volume percentage. Critical for understanding solids
            loading.
          </p>
        </div>

        <div class="help-metric">
          <h4>📊 Chart Configuration</h4>
          <p>
            <strong>Line Chart:</strong> Shows trends over time with connected
            data points. Best for viewing continuous changes and patterns.
          </p>
          <p>
            <strong>Scatter Plot:</strong> Shows individual data points without
            connections. Better for identifying outliers and data distribution.
          </p>
          <p>
            <strong>Secondary Axis (RPM):</strong> Displays paddle RPM data
            alongside primary measurements to correlate mixing intensity with
            particle behavior.
          </p>
        </div>

        <div class="help-metric">
          <h4>🔮 Forecasting Methods</h4>
          <p>
            <strong>Adaptive:</strong> Best for data with trend changes.
            Automatically adjusts polynomial order based on data
            characteristics. Recommended for most analyses.
          </p>
          <p>
            <strong>Windowed:</strong> Uses a sliding window approach focusing
            on recent stable periods. Good for systems with changing operating
            conditions.
          </p>
          <p>
            <strong>Weighted:</strong> Emphasizes recent data points gradually.
            Useful when recent measurements are more representative of current
            conditions.
          </p>
          <p>
            <strong>Simple:</strong> Uses all available data with standard
            polynomial regression. Best for very stable systems with consistent
            trends.
          </p>
          <p>
            <strong>Forecast Start Time:</strong> Controls when forecasting
            begins (typically 10-20 minutes). Earlier start provides more
            prediction data but may be less accurate.
          </p>
          <p>
            <strong>Forecast Window:</strong> Amount of historical data used for
            prediction. Larger windows provide stability but may miss recent
            changes.
          </p>
        </div>

        <div class="help-metric">
          <h4>⏰ Time Window Selection</h4>
          <p><strong>Full Duration:</strong> Uses all available data points.</p>
          <p>
            <strong>Steady State:</strong> Excludes first 5 minutes to avoid
            startup transients.
          </p>
          <p>
            <strong>Final 10 Minutes:</strong> Uses only the last 10 minutes
            when system should be most stable.
          </p>
          <p>
            <strong>Custom Range:</strong> Allows you to specify exact time
            bounds for analysis.
          </p>
        </div>

        <div class="help-metric">
          <h4>🧹 Filtering Options</h4>
          <p>
            <strong>Remove Outliers (IQR Method):</strong> Removes values beyond
            1.5 × IQR from quartiles. Good for eliminating sensor spikes.
          </p>
          <p>
            <strong>Smooth Data (Moving Average):</strong> Applies 5-point
            moving average to reduce noise while preserving trends.
          </p>
          <p>
            <strong>Both:</strong> First removes outliers, then smooths the
            remaining data for maximum noise reduction.
          </p>
        </div>

        <div class="help-metric">
          <h4>📊 Basic Statistics</h4>
          <p>
            <strong>Min/Max:</strong> The lowest and highest values in your
            dataset. Useful for understanding the operational range.
          </p>
          <p>
            <strong>Mean (Average):</strong> Sum of all values divided by count.
            Most commonly used for reporting.
          </p>
          <p>
            <strong>Median:</strong> The middle value when data is sorted. Less
            affected by outliers than the mean.
          </p>
          <p>
            <strong>Standard Deviation:</strong> Measures data spread around the
            mean. Lower values indicate more consistent performance.
          </p>
        </div>

        <div class="help-metric">
          <h4>📈 Advanced Statistics</h4>
          <p>
            <strong>Coefficient of Variation (CV):</strong> Standard deviation
            divided by mean, expressed as percentage. Useful for comparing
            variability across different parameters.
          </p>
          <p>
            <strong>Percentiles (P10, P90):</strong> Values below which 10% and
            90% of data falls. Helps identify typical operating ranges.
          </p>
          <p>
            <strong>Interquartile Range (IQR):</strong> Difference between 75th
            and 25th percentiles. Shows the spread of the middle 50% of data.
          </p>
        </div>

        <div class="help-metric">
          <h4>🔊 Noise Assessment</h4>
          <p>
            <strong>Noise Level:</strong> Estimated using coefficient of
            variation and outlier detection:
          </p>
          <div class="help-ranges">
            <div class="help-range excellent">Low: CV &lt; 15%</div>
            <div class="help-range good">Medium: CV 15-30%</div>
            <div class="help-range poor">High: CV &gt; 30%</div>
          </div>
        </div>

        <div class="help-metric">
          <h4>🎯 Quality Metrics (R², RMSE, MAE, MAPE)</h4>
          <p>
            <strong>R² (Coefficient of Determination):</strong> Measures how
            well the forecast model explains data variance. Values closer to 1.0
            indicate better fits.
          </p>
          <div class="help-ranges">
            <div class="help-range excellent">≥ 0.90 Excellent</div>
            <div class="help-range good">0.70-0.89 Good</div>
            <div class="help-range fair">0.50-0.69 Fair</div>
            <div class="help-range poor">&lt; 0.50 Poor</div>
          </div>
          <p>
            <strong>RMSE (Root Mean Square Error):</strong> Average prediction
            error in data units. Lower values indicate better accuracy.
          </p>
          <p>
            <strong>MAE (Mean Absolute Error):</strong> Average absolute
            prediction error. Less sensitive to outliers than RMSE.
          </p>
          <p>
            <strong>MAPE (Mean Absolute Percentage Error):</strong>
            Percentage-based error metric, easy to interpret regardless of data
            scale.
          </p>
        </div>

        <div class="help-metric">
          <h4>💡 Best Practices</h4>
          <p>
            <strong>Data Quality:</strong> Review raw data for sensor errors or
            unusual spikes before analysis. Use filtering options to clean noisy
            data.
          </p>
          <p>
            <strong>Steady State Analysis:</strong> Focus on steady state
            periods (after 5-10 minutes) for most accurate performance
            assessments.
          </p>
          <p>
            <strong>Forecasting Tips:</strong> Start with Adaptive method and
            adjust if needed. Use forecast metrics to validate model quality.
          </p>
          <p>
            <strong>Reporting:</strong> Include both raw data trends and
            filtered statistics in reports. Document any data filtering applied.
          </p>
        </div>
      </div>
    </div>

    <!-- Notification System -->
    <div id="notificationContainer" class="notification-container"></div>

    <!-- Local JavaScript -->
    <script src="script.js?v=8"></script>
  </body>
</html>
